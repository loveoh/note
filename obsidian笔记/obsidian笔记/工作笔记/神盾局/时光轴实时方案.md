## 项目背景
  神盾局用户旅程一期已完成上线，用户旅程数据为T-1的离线数据，为了满足客诉场景中的实时性，需要完成用户时光轴的实时数据的接入，从而更方便，快捷的对客诉用户进行复盘或处理。首期实时先接入用户的理赔数据及投诉数据。
## 技术方案
**技术思路：**
- 理赔、投诉等实时数据通过事件中心进行oneid的lookup操作，补全oneid字段，同时对数据进行清洗转换（添加字段，映射字段名称，映射字段值等）等操作
- 清洗后的数据写入ots中对应的用户实时事件表（只保留当天数据）。
- 离线加工保单信息，理赔信息等相关ots维表，投诉状态、理赔状态等相关信息维护实时ots维表
- 实时查询用户时光轴数据时，根据实际场景进行维表的关联，进而补全所需字段。

### 实时数据链路：
![[Pasted image 20240301151623.png]]
1.  理赔、投诉等实时数据，通过在事件中心配置数据源，进行数据清洗（关联oneid，转换字段名，映射字段值等）
2. 清洗后的实时数据，写入到ots实时维表中（主键：oneid,action_time,event_code,num）
3. 理赔、投诉实时状态表，通过监听理赔、投诉实时数据，通过事件中心配置对应的主键以及状态字段，实时写入ots维表，利用主键不同新增，主键相同更新的特性来构建最新状态维表。

### 应用查询：
![[Pasted image 20240229175227.png]]
- 用户在查询用户时光轴页面填写对应的查询信息及筛选条件。
- 应用服务器通过多线程分别查询用户离线事件表和用户实时事件表。
- 通过oneid查询实时事件表中的用户事件数据，如果实时数据不为空。
- 通过规则校验，该数据是否需要关联维表，进行字段补充。
- 如果需要补充字段，拼接查询条件查询对应的信息维表，进行实时数据补充。
- 将查询出的实时数据及离线数据集进行merge操作。
- 根据用户的筛选条件进行数据集的过滤后，再进行分页、排序等操作后返回前端。

### 关键信息：

**实时事件表信息**
- ots实时事件表名：adm_cust_time_line_event_detail_real
- ots实时事件表主键：oneid,action_time,event_code,num
- 理赔：
     topic：P-edw_ent_claim_detail_all-202312071351
     缺失信息：1.最新状态，2.当事人相关信息，3.保单相关信息
- 投诉：
	  topic：P-cdm_cs_ark_ocs_detl_realtime-202311281907
	  缺失信息：1、最新状态，2.保单信息，3.12378虚拟工单号

**实时状态表信息：**
- ots实时状态表名：adm_cust_time_line_event_status_real
- ots实时状态表信息：主键：business_id，列：status，timestamp



