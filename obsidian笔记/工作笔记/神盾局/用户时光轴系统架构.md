### 背景

 为应对业务各场景的诉求，提升业务复盘效率，更快速准确响应客诉等。将用户数据进行采集转换，并根据不同的业务场景展示对应的时光轴。如客服不同场景关注的重点不同，显示不同的时光轴数据（老年人队列 vs 普通队列 vs 投诉专线等）。
 
### 技术设计方案

#### 设计思路：

- 离线数仓将用户相关的数据（行为，服务，保单，触达等数据）进行采集、转换、计算，并结合用户的oneid数据构建用户基础信息表、用户时光轴表、通话记录表等。
- 实时数据通过监听业务库中mysql的binlog，并通过事件中心对数据做基础的格式转换、lookup oneid等操作，并将用户相关的实时数据写入ots对应的实时时光轴表。
- 神盾局应用层面通过多线程并发查询实时数据及离线数据，并通过对应的数据逻辑规则进行数据merge操作，从而实现用户时光轴数据实时查询

#### 技术架构及数据链路：

**技术架构：**

![[Pasted image 20240320113307.png]]

**数据链路：**
![[Pasted image 20240320113417.png]]

#### 表结构设计
**时光轴ots表**

| 表名                              | 主键                                     | 描述      | 备注                 |
| ------------------------------- | -------------------------------------- | ------- | ------------------ |
| adm_cust_time_line_event_basic  | oneid                                  | 用户基础信息表 | 接口通过主键点查获取用户信息     |
| adm_cust_time_line_event_detail | (oneid,action_time,<br>event_code,num) | 用户时光轴数据 | 接口通过主键进行范围扫描获取用户数据 |
| cdm_cust_time_line_event_text   | message_id                             | 用户沟通数据  | 通过会话id查询用户沟通信息数据   |

**时光轴MysqlER图**

![[Pasted image 20240320115637.png]]
**时光轴表信息：**

| 表名                               | 表描述          | 备注             |
| -------------------------------- | ------------ | -------------- |
| risk_timeline_prop_enum          | 属性枚举信息表      | 存储该属性下属性值相关枚举值 |
| risk_timeline_user_metric_detail | 用户指标信息详情表    | 保存用户自定义指标信息    |
| risk_timeline_event_prop_config  | 时光轴事件属性配置表   | 保存用户属性基础信息配置   |
| risk_timeline_metric_config      | 指标信息配置表      | 指标信息配置表        |
| risk_timeline_metric_expression  | 指标计算逻辑配置表达式表 | 记录指标计算的底层逻辑    |

**权限设计：**
**ER图**
![[Pasted image 20240320135740.png]]
![[Pasted image 20240320135834.png]]

|                                 |              |                   |
| ------------------------------- | ------------ | ----------------- |
| 表名                              | 表描述          | 备注                |
| risk_auth_user_role_rel         | 平台用户角色关联表    | 存储用户及角色的关联关系数据1对多 |
| risk_auth_resource              | 资源信息配置表      | 存储资源信息如页面，菜单等     |
| risk_auth_role_data_rel         | 角色与数据权限关系表   | 角色具有的数据权限1对多      |
| risk_auth_role_info             | 平台角色信息表      | 角色信息              |
| risk_auth_role_resource_rel     | 平台资源与角色关系表   | 角色与资源关系表，1对多      |
| risk_auth_role_user_visible_rel | 角色与用户可见范围关联表 | 角色与可见范围权限，1对多     |
| risk_auth_user_info             | 平台用户表        | 用户基础信息数据          |

#### 查询流程图

**用户时光轴数据查询流程：**

![[Pasted image 20240229175227.png]]

- 用户在查询用户时光轴页面填写对应的查询信息及筛选条件。
- 应用服务器通过多线程分别查询用户离线事件表和用户实时事件表。
- 通过oneid查询实时事件表中的用户事件数据，如果实时数据不为空。
- 通过规则校验，该数据是否需要关联维表，进行字段补充。
- 如果需要补充字段，拼接查询条件查询对应的信息维表，进行实时数据补充。
- 将查询出的实时数据及离线数据集进行merge操作。
- 根据用户的筛选条件进行数据集的过滤后，再进行分页、排序等操作后返回前端。

**接口查询耗时：**

|                                         |          |         |         |         |
| --------------------------------------- | -------- | ------- | ------- | ------- |
| 接口                                      | 接口描述     | 平均值(ms) | 95线(ms) | 50线(ms) |
| /riskplatform/timeline/gettimelinedata  | 查询用户时光轴  | 208.04  | 570.88  | 162.74  |
| /riskplatform/timeline/getchatrecords   | 查询用户沟通记录 | 126.27  | 274.68  | 117.23  |
| /riskplatform/timeline/getuserinfo      | 查询用户个人信息 | 136.68  | 394.46  | 88.83   |
| /riskplatform/timeline/geteventproperty | 查询事件属性信息 | 76.31   | 136.66  | 88.19   |
